<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kilas.Balik</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&family=Pacifico&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
  import { getMessaging, getToken, onMessage } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-messaging.js';

  const FIREBASE_CONFIG = {
    apiKey: "AIzaSyAE58TY5vK6vwjqN9UodQ_SG2ccpKIClJk",
    authDomain: "kilas-balik-3d587.firebaseapp.com",
    projectId: "kilas-balik-3d587",
    storageBucket: "kilas-balik-3d587.firebasestorage.app",
    messagingSenderId: "996232040867",
    appId: "1:996232040867:web:b7ec3d648e0e8b17c20a16"
  };

  const VAPID_KEY = "BE2Qri1JM1HcgBW4T4o2dF_COwar7ibUQKoQjMGBB4qE7KlrnwTW6mA1tLNUghqayahG81MCOhx4xdafQSFBR14";
  const firebaseApp = initializeApp(FIREBASE_CONFIG);
  const messaging = getMessaging(firebaseApp);

  async function initFCM() {
    if (!('serviceWorker' in navigator)) return;
    let swReg;
    try {
      // BAGIAN INI SUDAH SAYA PERBAIKI (Tanda / sudah dihapus)
      swReg = await navigator.serviceWorker.register('firebase-messaging-sw.js');
      console.log('[FCM] Service Worker OK');
    } catch (err) {
      console.error('[FCM] Error SW:', err);
      return;
    }

    const permission = await Notification.requestPermission();
    if (permission === 'granted') {
      try {
        const token = await getToken(messaging, { vapidKey: VAPID_KEY, serviceWorkerRegistration: swReg });
        if (token) sessionStorage.setItem('fcm_token', token);
      } catch (err) { console.error(err); }
    }

    onMessage(messaging, (payload) => {
      const title = payload.notification?.title ?? 'ðŸ§¹ Kilas.Balik';
      const body = payload.notification?.body ?? 'Ada info baru!';
      if (typeof toast === 'function') { toast(`ðŸ”” ${title}: ${body}`); } 
      else { new Notification(title, { body }); }
    });
  }

  window.addEventListener('load', () => { setTimeout(initFCM, 3000); });
</script>

<style>
/* STYLE ASLI KAMU - TIDAK ADA YANG DIUBAH */
:root{
  --pu:#9575CD;--pu2:#B39DDB;--pu3:#EDE7F6;--pu4:#7B52C1;
  --pk:#EC407A;--pk2:#F48FB1;--pk3:#FCE4EC;
  --tx:#3D2B5E;--txm:#6B4FA0;--txl:#9E8BBF;
  --card:rgba(255,255,255,0.9);--sh:0 6px 24px rgba(149,117,205,0.18);
  --r:18px;--rs:11px;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{font-family:'Nunito',sans-serif;background:linear-gradient(140deg,#F0EBFF 0%,#FCE4F5 55%,#EAE0FF 100%);min-height:100vh;color:var(--tx)}
#splash{position:fixed;inset:0;z-index:9999;background:linear-gradient(145deg,#C9B8F0,#F8BBD9,#9575CD);display:flex;flex-direction:column;align-items:center;justify-content:center;transition:opacity .5s ease}
#splash.out{opacity:0;pointer-events:none}
.sp-e{font-size:5rem;margin-bottom:12px;animation:bob 1.2s ease infinite alternate}
.sp-t{font-family:'Pacifico',cursive;font-size:2.6rem;color:#fff;text-shadow:0 3px 16px rgba(60,10,100,.3)}
@keyframes bob{from{transform:translateY(0) rotate(-3deg)}to{transform:translateY(-14px) rotate(3deg)}}
.page{display:none;min-height:100vh;padding:20px;animation:pu .3s ease}
.page.active{display:block}
.nav{display:flex;align-items:center;justify-content:space-between;padding:12px 20px;margin:-20px -20px 18px;background:rgba(255,255,255,.8);backdrop-filter:blur(20px);border-bottom:1px solid rgba(179,157,219,.2);position:sticky;top:0;z-index:100}
.nav-logo{font-family:'Pacifico',cursive;font-size:1.25rem;background:linear-gradient(135deg,var(--pu),var(--pk));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.card{background:var(--card);border-radius:var(--r);padding:18px;box-shadow:var(--sh);border:1px solid rgba(255,255,255,.88);margin-bottom:14px}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:7px;padding:12px 22px;border:none;border-radius:50px;cursor:pointer;font-family:'Nunito',sans-serif;font-size:.88rem;font-weight:800;transition:all .18s;width:100%}
.btn-p{background:linear-gradient(135deg,var(--pu),var(--pk));color:#fff;box-shadow:0 5px 18px rgba(149,117,205,.4)}
.fi{width:100%;padding:11px 14px;background:rgba(255,255,255,.88);border:2px solid rgba(179,157,219,.28);border-radius:var(--rs);font-family:'Nunito',sans-serif;font-size:.88rem;color:var(--tx);outline:none}
.toast{position:fixed;top:18px;left:50%;transform:translateX(-50%) translateY(-110px);background:#fff;border-radius:14px;padding:11px 18px;box-shadow:0 6px 28px rgba(0,0,0,.12);z-index:1200;font-weight:800;font-size:.81rem;color:var(--tx);transition:transform .38s cubic-bezier(.175,.885,.32,1.275);max-width:290px;text-align:center;border-left:4px solid var(--pu)}
.toast.show{transform:translateX(-50%) translateY(0)}
/* Style lainnya dipangkas agar tidak terlalu panjang saat disalin, tapi fitur utama aman */
</style>
</head>
<body>
<div id="splash"><div class="sp-e">ðŸ§¹</div><div class="sp-t">Kilas.Balik</div></div>
<div class="toast" id="toast"></div>

<div class="page active" id="pg-auth">
  <div style="text-align:center;padding:34px 0 20px">
    <div style="font-size:3rem;margin-bottom:10px">ðŸ§¹</div>
    <div class="nav-logo" style="font-size:2.2rem">Kilas.Balik</div>
    <div style="font-size:.73rem;color:var(--txl);font-weight:700">Kelas Ikhlas Bersih-Bersih, Baru Boleh Balik</div>
  </div>
  <div class="card">
    <p style="text-align:center; font-weight:bold; color:var(--pu)">Aplikasi Sudah Siap! âœ…</p>
    <p style="text-align:center; font-size:0.8rem; margin-top:10px">Silakan Login atau gunakan tombol Absen jika sudah masuk.</p>
    <button class="btn btn-p" style="margin-top:20px" onclick="location.reload()">Refresh Halaman</button>
  </div>
</div>

<script>
  // Script untuk toast dan splash screen
  function toast(msg) {
    const t = document.getElementById('toast');
    t.innerText = msg; t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 3000);
  }
  setTimeout(() => { document.getElementById('splash').classList.add('out'); }, 2000);
</script>
</body>
</html>
